<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
    <title>吉方玉个人博客</title>
    <meta name="Keywords" content="吉方玉个人博客网站" >
    <meta name="Description" content="个人博客" >
    <link href="../css/index.css" rel="stylesheet">
    <link href="../css/share.css" rel="stylesheet">
    <link href="../css/knowledge.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="../js/modernizr.js"></script>

    <![endif]-->
    <!--[if IE 6]>
    <script  src="../js/png.js"></script>
    <script type="text/javascript">
        EvPNG.fix('.lace_hd_ft,.emails,.rssdy,.fav');
    </script>
    <![endif]-->
    <link href='http://fonts.googleapis.com/css?family=La+Belle+Aurore' rel='stylesheet' type='text/css'>
</head>
<body onload="initial();">
<figure><p><a class="emails" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=978752808@qq.com" title="email"></a>
    <a class="rssdy" target="_blank" href="/e/web/?type=rss2"  title="rss订阅"></a><a class="fav" target="_blank" onClick="window.external.addFavorite('http://www.jify.com')" title="加入收藏"></a></p></figure>
<header>
    <h1><a href="../index.html">夏雨，影韵</a></h1>
    <p>我们都不是随便的一个人遇到另一个人，我们都是经过跋山涉水，慢慢长路才找到彼此的，所以要懂得珍惜！</p>
</header>
<!--nav begin-->
<div id="nav">
    <ul>
        <li><a href="../index.html" title="首页" style="font-weight: 400" >首页</a></li>
        <li><a href="../about.html"  title="关于我">关于我</a></li>
        <li ><a id="nav_current" href="../knowledge.html"  title="前端技术">前端技术</a></li>
        <li><a href="../essay.html"  title="生活随笔">生活随笔</a></li>
        <li><a href="../works.html"  title="作品展示">作品展示</a></li>
        <li><a href="../experience.html"  title="经验交流">经验交流</a></li>
        <li><a href="../message.html"  title="留言版">留言版</a></li>
    </ul>
</div>


<!--nav end-->
<div class="lace_hd_ft"></div>
<article>
    <div class="blog">
        <div class="bloglist">
            <h2><a href="../knowledge/JavaScript包管理器.html">Yarn：一个新的JavaScript包管理器</a></h2>
            <p class="dateview"><span>2016-01-01</span><span>作者：吉方玉</span><span>个人博客：[<a href="../knowledge.html">前端技术</a>]</span></p>

            <ul class="content1">
                <p>在JavaScript社区，工程师们分享了成百上千的代码段，我们不用自己从头编写基础组件、类库或者框架。反过来，每段代码又或许依赖于其它的代码段，而这些依赖就是通过 package managers(包管理器) 来管理的。最流行的JavaScript包管理器就是 npm客户端了，它可以访问在npm注册的 300,000 多个安装包。超出500万的工程师使用npm注册，每个月的下载量高达 50 亿。</p>
                <p>我们成功地在Facebook用了几年的npm客户端。但随着代码库规模的扩大以及开发者人数的增加，我们碰到了连贯性，安全性 和 性能 方面的问题。在迎难而上解决一个又一个的问题后，我们着手构建一个新的方案，来帮助我们更可靠地管理我们的依赖。执行这项工作的产品名为 Yarn -- 它是一个快速、可靠、安全的、可替换的npm客户端。</p>
                <p>我们很高兴地宣布与Exponent、 Google 和 Tilde 合作的 Yarn 开源版本。有了 Yarn之后, 软件工程师们仍然可以访问npm库，而且可以更快地安装npm包，并且跨机器或者在安全的离线环境下一致性地管理依赖。Yarn 使得工程师可以更加快速开发，并且信心百倍地使用分享的代码库，从而专注于更重要的事情 -- 构建新的产品和特性。</p>
                <p style="color: #00a000">Facebook JS 包管理器的进化史</p>
                <p>在还没包管理器的时候，JS工程师常常依赖于存储在他们项目中或者放在CDN上面的少量代码段。第一个主要的JS包管理器 npm 在Node.js被引用后不久就搭建起来了，并且迅速成为世界上最受欢迎的包管理器之一。上千个新的开源项目被建立了，工程师们也比以往分享了更多的代码。</p>
                <p>很多Facebook的项目（如React），都是依赖于npm包。然而，随着内部规模的扩大，我们都遇到了这样的问题：当跨机器或用户安装依赖时，拉取依赖包消耗的时间较长，也考虑到安全性的问题，因为npm客户端会自动执行这些依赖包里面的代码。我们尝试去解决这些问题，却发现这些问题还不断地衍生出新的问题。</p>
                <p style="color: #00a000">尝试操作npm客户端的规模</p>
                <p>起初，按照指定的最佳实践，我们只是检入 package.json 并且要求开发者手动地执行npm install 。这足以满足软件工程师的开发需求，但在我们持续集成的环境中就崩溃了，因为处于安全性和可靠性的考虑，这种环境需要沙箱化，并且切断网络服务。</p>
                <p>我们的第二个方案是检入所有进入代码库的 node_modules。这种做法虽然奏效，却使得一些原本简单的操作变得相当困难。举个例子，更新一个小版本 babel 就会生成一个80万行的commit，这对于无效的UTF8字节串、窗口的行尾退出符号，非 png-crushed 的图片等都很难处理。工程师们经常都要花上一整天的时间，才能把改动的代码合并到 node_modules中。我们掌控源代码的团队也指出：检查 node_modules 文件是对大量元数据负责任的做法。React Native 的 package.json 文件目前只是列出了68个依赖，但执行 npm install 之后，node_modules 目录下就生成了121，358个文件。</p>
                <p>我们做了最后一个尝试来规划npm客户端的大小，使之可以和开发者的数量以及我们所需的代码量来协调工作。我们觉得压缩整个 node_modules 文件夹，并且把它上传到内部的CDN，这样开发者和我们持续的集成系统都可以下载，并一致地提取文件。这使得我们可以从原文件中删除成千上百个文件。但是，这样做软件开发者不仅是拉取还是构建新代码，都需要网络服务。</p>
                <p>我们也必须应对 npm shrinkwrap 功能所带来的问题，因为我们通过 shrinkwrap 来锁定版本。npm-shrinkwrap.json 不是默认生成的，如果开发者忘记生成，就会导致不同步的问题。因此我们写了一个工具，来验证安装包里的文件与 node_modules 中的哪些文件相匹配。npm-shrinkwrap.json 是由大量无序字段组成的 JSON blobs ，所以改变它们就会生成庞大的、无法 review 的commits。为了缓和这个问题，我们需要额外添加一个脚本来区分所有的条目。</p>
                <p>基于 semantic versioning（语义法版本控制） 原则，用npm更新一个简单的依赖, 也会相应更新许多不相关的依赖。这样使得每次改变的代码量大大增加， 而且必须重复提交 node_modules 或者上传到CDN这样的事情，这个过程对开发者来说是不理想的。</p>
                <p style="color: #00a000">构建一个新的客户端</p>
                <p>我们决定尝试整体地去看待这个问题，而不是在npm客户端继续修复。假如我们尝试搭建了一个新的客户端来处理遇到的这些核心问题又会怎样呢？我们伦敦工作室的 Sebastian McKenzie 已经开始hack这个想法，我们也为它的前景而兴奋。</p>
                <p>随着这项工作的展开，我们开始和不同领域的工程师交流，并发现他们也遇到一系列类似的问题，也尝试了很多相同的解决方案，经常都是专注于解决眼下的问题。显然，通过结合大家所遇到的问题，我们可以开发一套共用的方案。在来自Exponent、Google 和 Tilde的工程师的帮助下，我们搭建了Yarn客户端，并在每个主要的JS框架上以及Facebook之外的场景测试和验证了它的性能。今天，我们带着激动的心情来和大家一起分享它。</p>
                <p style="color: #00a000">Yarn 简介</p>
                <p>Yarn 是一款新的包管理器，在取代npm客户端和其他包管理器现有工作流的同时，又保留了对npm代理的兼容性。它拥有与现有的工作流相同的特性，只是操作起来更快、更安全、更可靠。</p>
                <p>任何包管理器的主要功能都是去安装一些依赖模块 -- 一段服务于特定的目的代码 -- 从一个全局的注册到开发者的本地环境。包与包之间可能相互依赖，也可能是自己独立的。一个典型的项目的依赖包可能会有几十个、几百个或者是上千个。</p>
                <p>这些依赖都是版本化的，而且都是基于 语义版本控制 安装的。语义版本定义了一套版本的方案，无论是改了一个API，添加了一个新特性，还是修复了一个bug，都会在每个新版本上反映出来。然而，语义版本需要包开发者确保不出错，因为在依赖没有锁定的情况下，新的bug或漏洞都会被注入到依赖包里面。</p>
                <p>在Node环境下，依赖都放在你项目的 node_modules 文件夹下。然而，这些文件结构或许和实际的依赖树不一致，因为重复的依赖会被合并到一起。npm客户端在安装依赖到  node_modules 目录时顺序不是固定的。这意味着随着安装顺序的不同，不同开发者 node_modules 下的目录结构会存在差异。这种差异有可能引发“在我的电脑上是好的”bug，找出这种bug通常是比较耗时的。</p>
                <p>Yarn 通过 yarn.lock 和一个可靠、确定的算法解决了上面提及的版本控制和安装顺序这些问题。这些锁定文件为安装的依赖添加一个特定的版本号，并且确保在不同机器上安装时 node_modules 目录结构相同。lockfile 使用简明的书写格式和有序的 键 来确保改动尽量小，review起来更加简单。</p>
                <p>安装过程可拆分为三个步骤：</p>
                <p>①识别: 开始通过发送请求并依次查找每个依赖来识别其中的依赖关系。</p>
                <p>②获取: 接下来，Yarn 查看全局缓存来确定所需的安装包是否已经下载。如果没有，Yarn 就抓取压缩包并把它放在全局的缓存中，既可以做到离线工作，也可以确保以后需要时无须再次下载。依赖也可以像压缩包一样放在源码中，以便离线安装。</p>
                <p>③连接: 最后，Yarn 从全局的缓存中复制所需的文件放置到本地的 node_modules 目录下连接起来。</p>
                <p>通过明确地拆分这些步骤，得到确定的结果来实现并行操作，这样资源利用得到最大化，安装速度也大大提升。在Facebook 的一些项目中，Yarn 把安装速度提升了一个梯度，从几分钟到短短几秒。Yarn 也使用互斥来确保多个命令行安装时不会冲突或者互相污染。</p>
                <p>Yarn 对于整个压缩包的安装过程都有严格的保证。你可以控制不同生命周期的脚本来执行对应的安装包。压缩包 校验和 也被存储在 lockfile 以确保你每次都能拿到同样的压缩包。</p>
                <p style="color: #00a000">特性</p>
                <p>除了让安装过程更快更可靠，Yarn 还有额外的特性来更好地简化依赖管理的工作流。</p>
                <p>①兼容 npm 和 bower 工作流，并且支持混合注册。</p>
                <p>②能够限制已安装模块的证书以及输出证书信息。</p>
                <p>③暴露一个稳定公开的JS API，通过构建工具提供抽象的日志记录。</p>
                <p>④可读、最小化、良好的命令行输出。</p>
                <p style="color: #00a000">Yarn 在生产环境下</p>
                <p>我们已经在 Facebook 的生产环境下使用 Yarn 了，也运行得相当好。它颇有力度地为我们的很多 JavaScript 项目管理了依赖和压缩包。随着每次升级，工程师们已经能够离线搭建，并且加速他们的工作流。你可以在这里 查看不同环境下 React Native 分别用 Yarn 和 npm 的安装所消耗的时间。</p>
                <p>开始使用/p>
                <p>最简单的使用方式就是运行命令:</p>
                <p>在你的开发流程中 yarn CLI 取代了 npm , 要么用一个匹配的命令，要么使用一个新的、简单的命令:</p>
                <p>npm install → yarn</p>
                <p>不带参数的情况下，yarn 命令会读取你的 package.json 文件，从 npm 库中抓取所需的压缩包然后生成 node_modules 文件夹。这跟你运行 npm install 是一样的。</p>
                <p>我们移除了 npm install 的隐形依赖并拆分了命令。执行yarn后面加上&gl;name&gt; 与npm install --save &gl;name&gt;的是一样的。</p>
                <p style="color:#00a000 ">未来</p>
                <p>我们许多人聚集到一起，共同搭建了 Yarn 来解决常见的问题。我们希望 Yarn 可以真正成为一个开源项目，方便每个人使用。Yarn 现在已经放到 github 上了。我们也欢迎 Node 社区的伙伴们使用 Yarn，分享idea，撰写文档，我们互相支持，让更多人来关注它、使用它！我们相信 Yarn 已经有个很好的开端了，未来在大家的帮助下，一定会变得更好！
                </p>

            </ul>


            <div class="ds-share" data-thread-key="6" data-title="JavaScript包管理器" data-images="#"
                 data-content="在JavaScript社区，工程师们分享了成百上千的代码段，我们不用自己从头编写基础组件、类库或者框架。" data-url="./JavaScript包管理器.html">
                <div class="ds-share-inline">
                    <ul  class="ds-share-icons-16">

                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
                        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
                        <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
                        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

                    </ul>
                    <div class="ds-share-icons-more">
                    </div>
                </div>
            </div>

            <!-- 多说评论框 start -->
            <div class="ds-thread" data-thread-key="6" data-title="JavaScript包管理器" data-url="./JavaScript包管理器.html"></div>
            <!-- 多说评论框 end -->
            <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
            <script type="text/javascript">
                var duoshuoQuery = {short_name:"jifyu"};
                (function() {
                    var ds = document.createElement('script');
                    ds.type = 'text/javascript';ds.async = true;
                    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                    ds.charset = 'UTF-8';
                    (document.getElementsByTagName('head')[0]
                    || document.getElementsByTagName('body')[0]).appendChild(ds);
                })();
            </script>
            <!-- 多说公共JS代码 end -->
        </div>

    </div>

    </div>
    <aside class="right">
        <div class="rnav">
            <h2>栏目导航</h2>
            <ul>
                <li><a href="/download/" target="_blank">CSS3|Html5</a></li>
                <li><a href="/newsfree/" target="_blank">推荐工具</a></li>
                <li><a href="/newsfree/" target="_blank">心得笔记</a></li>
                <li><a href="/newsfree/" target="_blank">IP查询</a></li>
                <li><a href="/newsfree/" target="_blank">JS经典实例</a></li>
                <li><a href="/newsfree/" target="_blank">网站建设</a></li>
            </ul>
        </div>
        <div class="news">
            <h3>
                <p>最新<span>模板</span></p>
            </h3>
            <ul class="rank">
                <li><a href="../index/日月如梭.html">日月如梭韶华逝，愿你成为自己的太阳</a></li>
                <li><a href="../index/生活觅处.html">生活觅处搁一丝宁静在角落</a></li>
                <li><a href="../index/青春尾巴.html">踩在青春的尾巴上</a></li>
                <li><a href="../index/那些年.html">那些年写在青春里的永远</a></li>
                <li><a href="../knowledge/JavaScript包管理器.html">JavaScript包管理器</a></li>
                <li><a href="../knowledge/一些简单的前端面试题.html">一些简单的前端面试题</a></li>
            </ul>
            <h3 class="ph">
                <p>点击<span>排行</span></p>
            </h3>
            <ul class="paih">
                <li><a href="/" title="Column 三栏布局 个人网站模板" target="_blank">Column 三栏布局 个人网站模板</a></li>
                <li><a href="/" title="withlove for you 个人网站模板" target="_blank">with love for you 个人网站模板</a></li>
                <li><a href="/" title="免费收录网站搜索引擎登录口大全" target="_blank">免费收录网站搜索引擎登录口大全</a></li>
                <li><a href="/" title="做网站到底需要什么?" target="_blank">做网站到底需要什么?</a></li>
                <li><a href="/" title="企业做网站具体流程步骤" target="_blank">企业做网站具体流程步骤</a></li>
            </ul>
        </div>
        <div class="visitors">
            <h3><p>最近访客</p></h3>

            <ul class="ds-recent-visitors"></ul>
            <!--多说js加载开始，一个页面只需要加载一次 -->
            <script type="text/javascript">
                var duoshuoQuery = {short_name:"jifyu"};
                (function() {
                    var ds = document.createElement('script');
                    ds.type = 'text/javascript';ds.async = true;
                    ds.src = 'http://static.duoshuo.com/embed.js';
                    ds.charset = 'UTF-8';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
                })();
            </script>
            <!--多说js加载结束，一个页面只需要加载一次 -->


            <!--</ul>-->
        </div>
        <!-- Baidu Button BEGIN -->
        <div class="bdsharebuttonbox bdshare-button-style1-32"
             data-bd-bind="1477539538363" >

            <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
            <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
            <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
            <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
            <a href="#" class="bds_more" data-cmd="more"></a>
        </div>
        <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"32"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
        <script type="text/javascript">
            var cpro_id="u2063915";
            (window["cproStyleApi"] = window["cproStyleApi"] || {})[cpro_id]={at:"3",rsi0:"250",rsi1:"250",pat:"6",tn:"baiduCustNativeAD",rss1:"#FFFFFF",conBW:"1",adp:"1",ptt:"1",ptc:"%E7%8C%9C%E4%BD%A0%E6%84%9F%E5%85%B4%E8%B6%A3",ptFS:"14",ptFC:"#000000",ptBC:"#F2F2F2",titFF:"%E5%BE%AE%E8%BD%AF%E9%9B%85%E9%BB%91",titFS:"14",rss2:"#000000",titSU:"0",ptbg:"90",piw:"0",pih:"0",ptp:"0"}
        </script>
        <!-- Baidu Button END -->
    </aside>
</article>
<div class="blank"></div>
<footer>
    <p>Design by DevinDream <a href="http://www.miitbeian.gov.cn/" target="_blank">蜀ICP备11002373号-1</a> <a href="/">网站统计</a></p>
</footer>
<script src="../js/silder.js"></script>
</body>
</html>
